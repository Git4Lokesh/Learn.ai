<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synchronized Session - <%= session.title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --royal-purple: #7C3AED;
            --royal-blue: #2563EB;
            --royal-gold: #F59E0B;
            --dark-bg: #0F172A;
            --dark-card: #1E293B;
            --dark-border: #334155;
        }
        body {
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 25%, #312E81 50%, #7C3AED 100%);
            min-height: 100vh;
            color: #F8FAFC;
        }
        .session-container {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
        }
        .participant-sidebar {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 12px;
            padding: 1rem;
            height: fit-content;
            position: sticky;
            top: 100px;
        }
        .participant-item {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--dark-bg);
            border-radius: 8px;
        }
        .sync-indicator {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10B981;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .card-content {
            background: var(--dark-bg);
            border: 2px solid var(--dark-border);
            border-radius: 12px;
            padding: 2rem;
            min-height: 400px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--royal-purple) 0%, var(--royal-blue) 100%);
            border: 2px solid var(--royal-gold);
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/group-study/room/<%= session.room_id %>">
                <i class="bi bi-arrow-left me-2"></i><%= session.title %>
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="bi bi-people me-1"></i><span id="participantCount"><%= participants.length %></span> participants
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid" style="padding-top: 100px;">
        <div class="row">
            <div class="col-lg-9">
                <div class="session-container">
                    <div class="sync-indicator" id="syncIndicator">
                        <i class="bi bi-people-fill me-2"></i>
                        <span id="syncText">All participants viewing question <span id="currentPosition">1</span></span>
                    </div>
                    
                    <div class="card-content" id="contentArea">
                        <% if (content && contentType === 'flashcards') { %>
                            <% const flashcards = typeof content.content_data === 'string' ? JSON.parse(content.content_data) : content.content_data; %>
                            <div id="flashcardContainer">
                                <div class="text-center mb-4">
                                    <h3>Flashcard <span id="cardIndex">1</span> of <span id="totalCards"><%= flashcards.length %></span></h3>
                                </div>
                                <div class="card bg-dark border-warning mb-4" style="min-height: 300px;">
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        <div class="text-center" id="flashcardContent">
                                            <h4 id="questionText"><%= flashcards[0].question %></h4>
                                            <div id="answerText" style="display: none;">
                                                <hr>
                                                <h5><%= flashcards[0].answer %></h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-outline-light" id="prevBtn" onclick="previousCard()">
                                        <i class="bi bi-arrow-left me-2"></i>Previous
                                    </button>
                                    <button class="btn btn-warning" id="flipBtn" onclick="flipCard()">
                                        <i class="bi bi-arrow-repeat me-2"></i>Flip Card
                                    </button>
                                    <button class="btn btn-outline-light" id="nextBtn" onclick="nextCard()">
                                        Next<i class="bi bi-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>
                            <script>
                                let currentCardIndex = 0;
                                let isFlipped = false;
                                const flashcards = <%= JSON.stringify(flashcards) %>;
                                
                                function updateCard() {
                                    document.getElementById('cardIndex').textContent = currentCardIndex + 1;
                                    document.getElementById('questionText').innerHTML = flashcards[currentCardIndex].question;
                                    document.getElementById('answerText').innerHTML = `<hr><h5>${flashcards[currentCardIndex].answer}</h5>`;
                                    document.getElementById('answerText').style.display = 'none';
                                    isFlipped = false;
                                    document.getElementById('prevBtn').disabled = currentCardIndex === 0;
                                    document.getElementById('nextBtn').disabled = currentCardIndex === flashcards.length - 1;
                                    
                                    // Sync position
                                    socket.emit('sync_flashcard', { roomId: <%= session.room_id %>, currentIndex: currentCardIndex });
                                }
                                
                                function flipCard() {
                                    isFlipped = !isFlipped;
                                    document.getElementById('answerText').style.display = isFlipped ? 'block' : 'none';
                                }
                                
                                function nextCard() {
                                    if (currentCardIndex < flashcards.length - 1) {
                                        currentCardIndex++;
                                        updateCard();
                                    }
                                }
                                
                                function previousCard() {
                                    if (currentCardIndex > 0) {
                                        currentCardIndex--;
                                        updateCard();
                                    }
                                }
                                
                                socket.on('flashcard_synced', (data) => {
                                    if (data.currentIndex !== currentCardIndex) {
                                        currentCardIndex = data.currentIndex;
                                        updateCard();
                                    }
                                });
                                
                                updateCard();
                            </script>
                        <% } else if (content && contentType === 'quiz') { %>
                            <% const quiz = typeof content.content_data === 'string' ? JSON.parse(content.content_data) : content.content_data; %>
                            <div id="quizContainer">
                                <div class="text-center mb-4">
                                    <h3>Question <span id="questionIndex">1</span> of <span id="totalQuestions"><%= quiz.length %></span></h3>
                                </div>
                                <div id="quizQuestions">
                                    <% quiz.forEach((q, idx) => { %>
                                        <div class="question-item" data-question-idx="<%= idx %>" style="<%= idx === 0 ? '' : 'display: none;' %>">
                                            <h4 class="mb-3"><%= q.question %></h4>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" name="answer_<%= idx %>" id="opt1_<%= idx %>" value="option1">
                                                <label class="form-check-label" for="opt1_<%= idx %>"><%= q.option1 %></label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" name="answer_<%= idx %>" id="opt2_<%= idx %>" value="option2">
                                                <label class="form-check-label" for="opt2_<%= idx %>"><%= q.option2 %></label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" name="answer_<%= idx %>" id="opt3_<%= idx %>" value="option3">
                                                <label class="form-check-label" for="opt3_<%= idx %>"><%= q.option3 %></label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" name="answer_<%= idx %>" id="opt4_<%= idx %>" value="option4">
                                                <label class="form-check-label" for="opt4_<%= idx %>"><%= q.option4 %></label>
                                            </div>
                                        </div>
                                    <% }); %>
                                </div>
                                <div class="d-flex justify-content-between mt-4">
                                    <button class="btn btn-outline-light" id="prevQuestionBtn" onclick="previousQuestion()" disabled>Previous</button>
                                    <button class="btn btn-primary" id="nextQuestionBtn" onclick="nextQuestion()">Next</button>
                                </div>
                            </div>
                            <script>
                                let currentQuestionIndex = 0;
                                const quiz = <%= JSON.stringify(quiz) %>;
                                const userAnswers = {};
                                
                                function updateQuestion() {
                                    document.querySelectorAll('.question-item').forEach((item, idx) => {
                                        item.style.display = idx === currentQuestionIndex ? 'block' : 'none';
                                    });
                                    document.getElementById('questionIndex').textContent = currentQuestionIndex + 1;
                                    document.getElementById('prevQuestionBtn').disabled = currentQuestionIndex === 0;
                                    document.getElementById('nextQuestionBtn').textContent = currentQuestionIndex === quiz.length - 1 ? 'Submit Quiz' : 'Next';
                                    
                                    // Sync position
                                    socket.emit('sync_quiz', { roomId: <%= session.room_id %>, questionIndex: currentQuestionIndex });
                                }
                                
                                function nextQuestion() {
                                    // Save answer
                                    const selected = document.querySelector(`input[name="answer_${currentQuestionIndex}"]:checked`);
                                    if (selected) {
                                        userAnswers[currentQuestionIndex] = selected.value;
                                    }
                                    
                                    if (currentQuestionIndex < quiz.length - 1) {
                                        currentQuestionIndex++;
                                        updateQuestion();
                                    } else {
                                        submitQuiz();
                                    }
                                }
                                
                                function previousQuestion() {
                                    if (currentQuestionIndex > 0) {
                                        currentQuestionIndex--;
                                        updateQuestion();
                                    }
                                }
                                
                                function submitQuiz() {
                                    // Calculate score
                                    let score = 0;
                                    for (let i = 0; i < quiz.length; i++) {
                                        if (userAnswers[i] === quiz[i].answer) {
                                            score++;
                                        }
                                    }
                                    
                                    fetch('/group-study/quiz/submit', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            roomContentId: <%= content.id %>,
                                            score: score,
                                            totalQuestions: quiz.length,
                                            timeTakenSeconds: 0,
                                            skillId: '<%= content.topic %>',
                                            roomId: <%= session.room_id %>
                                        })
                                    })
                                    .then(() => {
                                        alert(`Quiz submitted! Score: ${score}/${quiz.length}`);
                                        window.location.href = '/group-study/room/<%= session.room_id %>';
                                    });
                                }
                                
                                socket.on('quiz_synced', (data) => {
                                    if (data.questionIndex !== currentQuestionIndex) {
                                        currentQuestionIndex = data.questionIndex;
                                        updateQuestion();
                                    }
                                });
                                
                                updateQuestion();
                            </script>
                        <% } else { %>
                            <p class="text-center text-muted">No content available for this session.</p>
                        <% } %>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3">
                <div class="participant-sidebar">
                    <h5><i class="bi bi-people me-2"></i>Participants</h5>
                    <div id="participantsList">
                        <% participants.forEach(p => { %>
                            <div class="participant-item" data-user-id="<%= p.user_id %>">
                                <span class="presence-indicator"></span>
                                <%= p.name %>
                                <% if (p.user_id === user.id) { %>
                                    <small class="text-muted">(You)</small>
                                <% } %>
                            </div>
                        <% }); %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io();
        const sessionId = <%= session.id %>;
        const userId = <%= user.id %>;
        const roomId = <%= session.room_id %>;
        
        // Join session socket room
        socket.emit('session_join', { sessionId, userId });
        socket.emit('join_room', { roomId, userId });
        
        socket.on('participant_joined', (data) => {
            // Update participant count
            const count = document.getElementById('participantsList').children.length + 1;
            document.getElementById('participantCount').textContent = count;
        });
        
        socket.on('position_synced', (data) => {
            document.getElementById('currentPosition').textContent = data.position + 1;
        });
    </script>
</body>
</html>

